<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.w3.org/1999/xhtml"
      layout:decorator="layouts/default">
<head lang="en" th:replace="~{fragments/header :: header }"></head>
<body>
<header id="topnav">
    <div class="navbar-overlay bg-animate"></div>
    <div th:replace="~{fragments/topnavbar :: top-navbar }"></div>
    <div th:replace="~{fragments/navbar :: navbar }"></div>
</header>
<div id="status" style="display: none;">
    <div class="spinner"></div>
</div>
<div class="wrapper boxed-layout">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="page-title-box">
                    <div class="page-title-right">
                        <div class="btn-group">
                            <button type="button" onclick="window.location.href='/users/list';" class="btn btn-sm btn-info waves-effect waves-light">Manage Users</button>
                        </div>
                    </div>
                    <h4 class="page-title">Add User</h4>
                </div>
            </div>
        </div>
        <!-- Display flash messages -->
        <div class="row" th:if="${error}">
            <div class="col-12">
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <span th:text="${error}"></span>
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            </div>
        </div>
        <div class="row" th:if="${success}">
            <div class="col-12">
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <span th:text="${success}"></span>
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-xl-12">
                <div class="card">
                    <div class="card-body">
                        <form th:action="@{/user/add}" method="POST" th:object="${user}" data-parsley-validate="">
                            <div id="basicwizard">
                                <ul class="nav nav-pills bg-light nav-justified form-wizard-header mb-4">
                                    <li class="nav-item">
                                        <a href="#user-details" data-toggle="tab" class="nav-link rounded-0 pt-2 pb-2 active">
                                            <i class="mdi mdi-account-card-details-outline mr-1"></i>
                                            <span class="d-none d-sm-inline">Details</span>
                                        </a>
                                    </li>
                                </ul>
                                <div class="tab-content b-0 mb-0 pt-0">
                                    <div class="tab-pane active" id="user-details">
                                        <div class="row">
                                            <div class="col-12">
                                                <div class="form-group row mb-4">
                                                    <label class="col-md-4 col-form-label" for="username">Username <span class="text-danger">*</span></label>
                                                    <div class="col-md-6">
                                                        <input type="text" class="form-control" id="username" th:field="*{username}" required>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <button type="button" onclick="generateNewUsername();" class="btn btn-secondary" style="width: 100%">Generate</button>
                                                    </div>
                                                </div>
                                                <div class="form-group row mb-4">
                                                    <label class="col-md-4 col-form-label" for="password">Password <span class="text-danger">*</span></label>
                                                    <div class="col-md-6">
                                                        <input type="text" class="form-control" id="password" th:field="*{password}" required data-indicator="pwindicator">
                                                        <div id="pwindicator">
                                                            <div class="bar"></div>
                                                            <div class="label"></div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <button type="button" onclick="generateNewPassword();" class="btn btn-secondary" style="width: 100%">Generate</button>
                                                    </div>
                                                </div>
                                                <div class="form-group row mb-4">
                                                    <label class="col-md-4 col-form-label" for="email">Email Address</label>
                                                    <div class="col-md-8">
                                                        <input type="email" id="email" class="form-control" th:field="*{email}">
                                                    </div>
                                                </div>
                                                <div class="form-group row mb-4">
                                                    <label class="col-md-4 col-form-label" for="member_group_id">Member Group <span class="text-danger">*</span></label>
                                                    <div class="col-md-8">
                                                        <select name="groupId" required id="member_group_id" class="form-control select2" data-toggle="select2" th:attr="data-selected=${user.groupId?.id}">
                                                            <option value="">Select a Group</option>
                                                            <option th:each="group : ${groups}"
                                                                    th:value="${group.id}"
                                                                    th:text="${group.groupName}"
                                                                    th:selected="${user.groupId != null && user.groupId.id == group.id}"/>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="form-group row mb-4">
                                                    <label class="col-md-4 col-form-label" for="owner_id">Owner</label>
                                                    <div class="col-md-6">
                                                        <select id="owner_id" name="ownerId" class="form-control select2" data-toggle="select2" th:attr="data-selected=${user.ownerId}">
                                                            <option value="0">None</option>
                                                            <option th:each="ownerUser : ${users}"
                                                                    th:value="${ownerUser.id}"
                                                                    th:text="${ownerUser.email} + ' (Username: ' + ${ownerUser.username} + ')'"
                                                                    th:selected="${user.ownerId != null && user.ownerId == ownerUser.id}"/>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <button type="button" onclick="clearOwner();" class="btn btn-warning" style="width: 100%">Clear</button>
                                                    </div>
                                                </div>
                                                <div class="form-group row mb-4">
                                                    <label class="col-md-4 col-form-label" for="credits">Credits</label>
                                                    <div class="col-md-2">
                                                        <input type="number" step="0.01" min="0" class="form-control text-center" id="credits" th:field="*{credits}" onkeypress="return isNumberKey(event)">
                                                    </div>
                                                    <div class="col-md-6">
                                                        <input type="text" class="form-control" id="credits_reason" name="creditsReason" placeholder="Reason for Adjustment...">
                                                    </div>
                                                </div>
                                                <div class="form-group row mb-4">
                                                    <label class="col-md-4 col-form-label" for="reseller_dns">Reseller DNS</label>
                                                    <div class="col-md-8">
                                                        <input type="text" class="form-control" id="reseller_dns" th:field="*{resellerDns}">
                                                    </div>
                                                </div>
                                                <div class="form-group row mb-4">
                                                    <label class="col-md-4 col-form-label" for="notes">Notes</label>
                                                    <div class="col-md-8">
                                                        <textarea id="notes" th:field="*{notes}" class="form-control" rows="3" placeholder=""></textarea>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <ul class="list-inline wizard mb-0">
                                            <li class="list-inline-item float-right">
                                                <input name="submit_user" type="submit" class="btn btn-primary" value="Add User"/>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<footer th:replace="~{fragments/footer :: footer }"></footer>
<script>
    function isNumberKey(evt) {
        var charCode = (evt.which) ? evt.which : evt.keyCode;
        if (charCode != 46 && charCode != 45 && charCode > 31 && (charCode < 48 || charCode > 57)) {
            return false;
        }
        return true;
    }

    function clearOwner() {
        $('#owner_id').val("0").trigger('change');
    }

    function generateNewUsername() {
        fetch('/api/generate-username')
            .then(response => response.text())
            .then(username => {
                $('#username').val(username);
            })
            .catch(error => {
                // Fallback to client-side generation
                const adjectives = ['Swift', 'Bold', 'Bright', 'Cool', 'Fast', 'Smart', 'Wild', 'Quick', 'Brave', 'Sharp'];
                const nouns = ['Tiger', 'Eagle', 'Wolf', 'Fox', 'Lion', 'Hawk', 'Bear', 'Shark', 'Falcon', 'Panther'];
                const randomNumber = Math.floor(Math.random() * 900) + 100;
                const username = adjectives[Math.floor(Math.random() * adjectives.length)] +
                    nouns[Math.floor(Math.random() * nouns.length)] + randomNumber;
                $('#username').val(username);
            });
    }

    function generateNewPassword() {
        fetch('/api/generate-password')
            .then(response => response.text())
            .then(password => {
                $('#password').val(password);
                // Trigger password strength indicator update
                $('#password').trigger('keyup');
            })
            .catch(error => {
                // Fallback to client-side generation
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
                let password = '';
                for (let i = 0; i < 12; i++) {
                    password += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                $('#password').val(password);
                // Trigger password strength indicator update
                $('#password').trigger('keyup');
            });
    }

    $(document).ready(function() {
        // Initialize select2 for dropdowns
        $('#member_group_id').select2({
            placeholder: 'Select a Group',
            width: '100%'
        });

        // Set the pre-selected group value if exists
        var selectedGroupId = $('#member_group_id').data('selected');
        if (selectedGroupId) {
            $('#member_group_id').val(selectedGroupId).trigger('change');
        }

        $('#owner_id').select2({
            ajax: {
                url: '/api/reguserlist',
                dataType: 'json',
                data: function(params) {
                    return {
                        search: params.term,
                        page: params.page || 1
                    };
                },
                processResults: function(data, params) {
                    params.page = params.page || 1;
                    return {
                        results: data.items,
                        pagination: {
                            more: (params.page * 100) < data.total_count
                        }
                    };
                },
                cache: true
            },
            placeholder: 'Search for an owner...',
            width: '100%'
        });

        // Set the pre-selected owner value if exists
        var selectedOwnerId = $('#owner_id').data('selected');
        if (selectedOwnerId && selectedOwnerId != 0) {
            $('#owner_id').val(selectedOwnerId).trigger('change');
        }

        // Initialize password strength indicator
        if (typeof $.fn.pwstrength !== 'undefined') {
            $('#password').pwstrength({ 'increase': true });
        }

        // Show validation messages
        $('form').on('submit', function(e) {
            var isValid = true;

            // Check required fields
            if (!$('#username').val().trim()) {
                isValid = false;
                $('#username').addClass('is-invalid');
            } else {
                $('#username').removeClass('is-invalid');
            }

            if (!$('#password').val().trim()) {
                isValid = false;
                $('#password').addClass('is-invalid');
            } else {
                $('#password').removeClass('is-invalid');
            }

            if (!$('#member_group_id').val()) {
                isValid = false;
                $('#member_group_id').addClass('is-invalid');
            } else {
                $('#member_group_id').removeClass('is-invalid');
            }

            if (!isValid) {
                e.preventDefault();
                return false;
            }
        });
    });
</script>
</body>
</html>